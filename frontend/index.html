<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>QB Data Loader</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script
    async
    crossorigin="anonymous"
    data-clerk-publishable-key="pk_test_d29ya2FibGUta2l0LTQ1LmNsZXJrLmFjY291bnRzLmRldiQ"
    src="https://workable-kit-45.clerk.accounts.dev/npm/@clerk/clerk-js@latest/dist/clerk.browser.js"
    type="text/javascript"
  ></script>
</head>
<body class="bg-gray-50 min-h-screen">
  <header class="bg-white shadow-sm border-b">
    <div class="max-w-4xl mx-auto px-8 py-4 flex justify-between items-center">
      <h1 class="text-2xl font-bold text-gray-800">QB Data Loader</h1>
      <div class="flex items-center gap-8">
        <div class="flex items-center gap-4 text-sm">
          <span id="qbo-status" class="text-gray-500">Checking QuickBooks...</span>
          <button id="connect-qbo-btn" onclick="startQBOAuth()" class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700 text-sm">
            Connect to QuickBooks
          </button>
        </div>
        <div id="clerk-mount"></div>
      </div>
    </div>
  </header>

  <div class="max-w-4xl mx-auto p-8">
    <!-- Upload Section -->
    <div id="upload-section">
      <div class="bg-white rounded-lg shadow p-8">
        <h2 class="text-2xl font-semibold mb-6">Upload CSV File</h2>
        <input type="file" id="file" accept=".csv" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded file:border-0 file:bg-blue-600 file:text-white hover:file:bg-blue-700 mb-6">
        <select id="object_type" class="px-4 py-2 border rounded mb-6">
          <option value="customer">Customer</option>
          <option value="invoice">Invoice (coming soon)</option>
        </select>
        <br>
        <button onclick="uploadForPreview()" class="px-8 py-4 bg-indigo-600 text-white text-lg rounded hover:bg-indigo-700">
          Upload & Preview Mapping
        </button>
      </div>
    </div>

    <!-- Mapping Section -->
    <div id="mapping-section" style="display:none" class="bg-white rounded-lg shadow p-8 mt-8">
      <h2 class="text-2xl font-semibold mb-6">Map Columns to QuickBooks Fields</h2>
      <p class="text-gray-600 mb-8">
        Map your CSV columns to QuickBooks fields. <span class="text-red-600 font-bold">DisplayName is required*</span>
      </p>
      <div id="mapping-fields" class="space-y-6 mb-10"></div>

      <div class="flex gap-4">
        <button id="start-import-btn" onclick="proceedToPreview()" disabled class="px-8 py-4 bg-green-600 text-white text-lg rounded opacity-50 cursor-not-allowed">
          Proceed to Preview
        </button>
        <button onclick="cancelPreview()" class="px-6 py-4 bg-gray-400 text-white rounded hover:bg-gray-500">
          Cancel
        </button>
      </div>
    </div>

    <!-- Preview Section -->
    <div id="preview-section" style="display:none" class="bg-white rounded-lg shadow p-8 mt-8">
      <h2 class="text-2xl font-semibold mb-6">Preview & Edit Data</h2>
      <p class="text-gray-600 mb-8">
        Review how your data will appear in QuickBooks. Edit any cell directly.
      </p>

      <!-- Validation Summary -->
      <div id="validation-summary" class="hidden mb-8 p-6 rounded-lg border">
        <p id="summary-text" class="text-lg font-medium"></p>
        <div class="mt-4 flex gap-8 text-sm items-center">
          <div><span class="font-bold text-green-700">Will Succeed:</span> <span id="success-count">0</span></div>
          <div><span class="font-bold text-red-700">Will Fail:</span> <span id="fail-count">0</span></div>
          <div><span class="font-bold text-yellow-700">Warnings:</span> <span id="warning-count">0</span></div>
          <div><span class="font-bold">Total:</span> <span id="total-count">0</span></div>
          
          <!-- Override Duplicates Checkbox -->
          <label class="ml-8 flex items-center gap-2 cursor-pointer">
            <input type="checkbox" id="override-duplicates" class="w-5 h-5 text-indigo-600 rounded focus:ring-indigo-500">
            <span class="text-sm font-medium text-gray-700">Override existing customers in QuickBooks</span>
          </label>
        </div>
      </div>

      <div class="overflow-x-auto mb-8">
        <table id="preview-table" class="min-w-full divide-y divide-gray-200">
          <thead class="bg-gray-50"></thead>
          <tbody class="bg-white divide-y divide-gray-200"></tbody>
        </table>
      </div>

      <div id="preview-actions" class="flex gap-4 items-center">
        <button id="dry-run-btn" onclick="startDryRun()" class="px-8 py-4 bg-indigo-600 text-white text-lg rounded hover:bg-indigo-700">
          Run Dry Run Simulation
        </button>
        <button onclick="backToMapping()" class="px-6 py-4 bg-gray-400 text-white rounded hover:bg-gray-500">
          Back to Mapping
        </button>
        <button id="start-real-import-btn" onclick="startRealImport()" 
                class="px-8 py-4 bg-orange-600 text-white text-lg rounded hover:bg-orange-700 hidden"
                disabled>
          Import Anyway (Safe Rows Only)
        </button>
      </div>
    </div>

    <!-- Recent Jobs -->
    <h2 class="text-2xl font-semibold mt-12 mb-6">Recent Jobs</h2>
    <div id="jobs" class="space-y-6"></div>
  </div>

  <script>
  // === GLOBALS ===
  const jobsEl = document.getElementById('jobs');
  let currentJobId = null;
  let hasUnvalidatedChanges = false;
  let csvHeaders = [];
  let previewRows = [];
  let mapping = {};
  let currentValidation = {};
  let overrideDuplicates = false;

  const QBO_FIELDS = [ /* unchanged - your full list */ 
    { value: "", label: "-- Not mapped --" },
    { value: "DisplayName", label: "DisplayName * (Required)" },
    { value: "CompanyName", label: "Company Name" },
    { value: "Title", label: "Title (Mr/Mrs)" },
    { value: "GivenName", label: "First Name" },
    { value: "MiddleName", label: "Middle Name" },
    { value: "FamilyName", label: "Last Name" },
    { value: "Suffix", label: "Suffix (Jr/Sr)" },
    { value: "PrintOnCheckName", label: "Print on Check As" },
    { value: "PrimaryEmailAddr.Address", label: "Primary Email" },
    { value: "WebAddr.URI", label: "Website" },
    { value: "PrimaryPhone.FreeFormNumber", label: "Primary Phone" },
    { value: "Mobile.FreeFormNumber", label: "Mobile Phone" },
    { value: "Fax.FreeFormNumber", label: "Fax" },
    { value: "AlternatePhone.FreeFormNumber", label: "Alternate Phone" },
    { value: "BillAddr.Line1", label: "Billing Address Line 1" },
    { value: "BillAddr.Line2", label: "Billing Address Line 2" },
    { value: "BillAddr.Line3", label: "Billing Address Line 3" },
    { value: "BillAddr.City", label: "Billing City" },
    { value: "BillAddr.CountrySubDivisionCode", label: "Billing State/Province" },
    { value: "BillAddr.PostalCode", label: "Billing ZIP/Postal" },
    { value: "BillAddr.Country", label: "Billing Country" },
    { value: "ShipAddr.Line1", label: "Shipping Address Line 1" },
    { value: "ShipAddr.Line2", label: "Shipping Address Line 2" },
    { value: "ShipAddr.City", label: "Shipping City" },
    { value: "ShipAddr.CountrySubDivisionCode", label: "Shipping State/Province" },
    { value: "ShipAddr.PostalCode", label: "Shipping ZIP/Postal" },
    { value: "ShipAddr.Country", label: "Shipping Country" },
    { value: "Notes", label: "Notes" },
    { value: "Taxable", label: "Taxable (true/false)" },
    { value: "Active", label: "Active (true/false)" },
    { value: "CurrencyRef.value", label: "Currency Code (e.g. USD)" }
  ];

  function handleCellEdit(inputElement, rowIndex, header) {
    const newValue = inputElement.value.trim();
    previewRows[rowIndex][header] = newValue;
  }

  // === AUTH & STATUS (unchanged) ===
  async function startQBOAuth() {
    const btn = document.getElementById('connect-qbo-btn');
    btn.disabled = true;
    btn.textContent = 'Opening QuickBooks...';

    try {
      const res = await fetchWithAuth('/api/auth_qbo/qbo/login');
      if (!res.ok) throw new Error(await res.text());
      const data = await res.json();

      const width = 600, height = 700;
      const left = screen.width / 2 - width / 2;
      const top = screen.height / 2 - height / 2;
      const popup = window.open(
        data.redirect_url,
        'qbo_auth',
        `width=${width},height=${height},left=${left},top=${top},resizable=yes,scrollbars=yes`
      );

      if (!popup) {
        alert('Popup blocked! Please allow popups for this site.');
        btn.disabled = false;
        btn.textContent = 'Connect to QuickBooks';
        return;
      }

      const handleSuccess = async (event) => {
        if (event.data === 'qbo_connected') {
          window.removeEventListener('message', handleSuccess);
          await updateQBOStatus();
          await loadJobs();
          btn.disabled = false;
          btn.textContent = 'Connect to QuickBooks';
        }
      };
      window.addEventListener('message', handleSuccess);

      const checkClosed = setInterval(async () => {
        if (popup.closed) {
          clearInterval(checkClosed);
          window.removeEventListener('message', handleSuccess);
          await updateQBOStatus();
          await loadJobs();
          btn.disabled = false;
          btn.textContent = 'Connect to QuickBooks';
        }
      }, 500);

    } catch (err) {
      alert('Error: ' + err.message);
      btn.disabled = false;
      btn.textContent = 'Connect to QuickBooks';
    }
  }

async function fetchWithAuth(url, options = {}) {
  // Create a proper Headers object to avoid overwriting
  const headers = new Headers(options.headers || {});

  let fetchOptions = {
    ...options,
    headers,
    credentials: "include"
  };

  if (!Clerk.session) {
    return fetch(url, fetchOptions);
  }

  try {
    const token = await Clerk.session.getToken();
    headers.set('Authorization', `Bearer ${token}`);

    return fetch(url, fetchOptions);
  } catch (err) {
    console.error("Token error:", err);
    return fetch(url, fetchOptions);
  }
}  
async function updateQBOStatus() {
    try {
      const res = await fetchWithAuth('/api/jobs/test-qbo-connection');
      if (res.ok) {
        const data = await res.json();
        document.getElementById('connect-qbo-btn').style.display = 'none';
        document.getElementById('qbo-status').innerHTML = `<span class="text-green-600 font-medium">‚úì Connected to ${data.company_name}</span>`;
      } else {
        document.getElementById('connect-qbo-btn').style.display = 'inline-block';
        document.getElementById('qbo-status').textContent = 'Not connected';
      }
    } catch (err) {
      document.getElementById('connect-qbo-btn').style.display = 'inline-block';
      document.getElementById('qbo-status').textContent = 'Not connected';
    }
  }
async function loadJobs() {
    // ... your existing loadJobs function (unchanged) ...
    try {
      const res = await fetchWithAuth('/api/jobs');
      if (!res.ok) {
        if (res.status === 401) {
          jobsEl.innerHTML = '<p class="text-gray-600">Please sign in to view your jobs.</p>';
        } else {
          jobsEl.innerHTML = '<p class="text-red-600">Failed to load jobs.</p>';
        }
        return;
      }
      const jobs = await res.json();
      if (jobs.length === 0) {
        jobsEl.innerHTML = '<p class="text-gray-600">No jobs yet. Upload a file to get started!</p>';
        return;
      }
      jobsEl.innerHTML = jobs.map(job => `
        <div class="bg-white p-6 rounded-lg shadow border-l-4 ${job.status.includes('error') || job.status.includes('fail') ? 'border-red-500' : 'border-green-500'}">
          <div class="flex justify-between">
            <div>
              <div class="font-semibold text-lg">${job.filename || 'Unknown file'}</div>
              <div class="text-sm text-gray-600">${job.object_type} ‚Ä¢ ${new Date(job.created_at).toLocaleString()}</div>
            </div>
            <div class="text-right">
              <div class="text-2xl font-bold">${job.status.replace(/_/g, ' ')}</div>
            </div>
          </div>
          <div class="mt-4 text-sm">
            Rows: ${job.total_rows || '?'}
            ${job.failed_rows !== undefined ? ` | Failed: ${job.failed_rows}` : ''}
          </div>
        </div>
      `).join('');
    } catch (err) {
      console.error("loadJobs error:", err);
      jobsEl.innerHTML = '<p class="text-red-600">Error loading jobs.</p>';
    }
  }

  // === UPLOAD & MAPPING ===
async function uploadForPreview() {
  const fileInput = document.getElementById('file');
  const file = fileInput.files[0];
  const type = document.getElementById('object_type').value;

  if (!file) return alert("Please select a CSV file");

  const form = new FormData();
  form.append('file', file);

  try {
    const res = await fetchWithAuth(`/api/import/${type}`, {
      method: 'POST',
      body: form
    });

    if (!res.ok) throw new Error(await res.text());

    const data = await res.json();
    currentJobId = data.job_id;
    csvHeaders = data.headers || [];
    previewRows = data.preview_rows || [];  // ‚Üê Now used!

    document.getElementById('upload-section').style.display = 'none';
    document.getElementById('mapping-section').style.display = 'block';

    renderMappingFields();     // ‚Üê Use the new dynamic renderer
    autoMapColumns();          // ‚Üê Use the improved auto-mapping
  } catch (err) {
    alert("Upload failed: " + err.message);
  }
}
function renderMappingFields() {
  const container = document.getElementById('mapping-fields');
  container.innerHTML = csvHeaders.map(header => `
    <div class="flex items-center gap-6 bg-gray-50 p-4 rounded-lg mapping-row">
      <div class="w-72 font-medium truncate">${header}</div>
      <span class="text-gray-500">‚Üí</span>
      <select class="mapping-select flex-1 px-4 py-2 border rounded bg-white" data-header="${header}">
        ${QBO_FIELDS.map(f => `<option value="${f.value}">${f.label}</option>`).join('')}
      </select>
      <button onclick="this.parentElement.remove(); checkRequiredFields()" class="text-red-600 hover:text-red-800">Remove</button>
    </div>
  `).join('');

  // Add custom mapping button
  container.innerHTML += `
    <button onclick="addCustomMapping()" class="mt-6 px-6 py-3 bg-blue-600 text-white rounded hover:bg-blue-700">
      + Add Custom Mapping
    </button>
  `;

  document.querySelectorAll('.mapping-select').forEach(checkRequiredFields);
  document.getElementById('mapping-fields').addEventListener('change', checkRequiredFields);
}
function addCustomMapping() {
  const container = document.getElementById('mapping-fields');
  const newRow = document.createElement('div');
  newRow.className = 'flex items-center gap-6 bg-gray-50 p-4 rounded-lg mapping-row';
  newRow.innerHTML = `
    <input type="text" placeholder="New CSV Column Name" class="w-72 px-4 py-2 border rounded custom-header">
    <span class="text-gray-500">‚Üí</span>
    <select class="mapping-select flex-1 px-4 py-2 border rounded bg-white">
      ${QBO_FIELDS.map(f => `<option value="${f.value}">${f.label}</option>`).join('')}
    </select>
    <button onclick="this.parentElement.remove(); checkRequiredFields()" class="text-red-600 hover:text-red-800">Remove</button>
  `;
  container.insertBefore(newRow, container.lastElementChild);
}
function autoMapColumns() {
  document.querySelectorAll('.mapping-select').forEach(select => {
    const header = select.dataset.header?.toLowerCase() || document.querySelector('.custom-header')?.value.toLowerCase() || '';
    if (!select.value) {
      if (header.includes('display') || header.includes('name') || header.includes('company') || header.includes('customer')) select.value = 'DisplayName';
      else if (header.includes('email')) select.value = 'PrimaryEmailAddr.Address';
      else if (header.includes('phone') && !header.includes('mobile') && !header.includes('fax')) select.value = 'PrimaryPhone.FreeFormNumber';
      else if (header.includes('mobile')) select.value = 'Mobile.FreeFormNumber';
      else if (header.includes('fax')) select.value = 'Fax.FreeFormNumber';
      else if (header.includes('website') || header.includes('web')) select.value = 'WebAddr.URI';
      else if (header.includes('city')) select.value = 'BillAddr.City';
      else if (header.includes('state') || header.includes('province')) select.value = 'BillAddr.CountrySubDivisionCode';
      else if (header.includes('zip') || header.includes('postal')) select.value = 'BillAddr.PostalCode';
    }
  });
  checkRequiredFields();
}
function checkRequiredFields() {
  const hasDisplayName = [...document.querySelectorAll('.mapping-select')].some(s => s.value === 'DisplayName');
  const btn = document.getElementById('start-import-btn');
  if (hasDisplayName) {
    btn.disabled = false;
    btn.classList.remove('opacity-50', 'cursor-not-allowed');
  } else {
    btn.disabled = true;
    btn.classList.add('opacity-50', 'cursor-not-allowed');
  }
}
  async function proceedToPreview() {
    mapping = {};
    document.querySelectorAll('.mapping-row').forEach(row => {
      const headerInput = row.querySelector('.custom-header');
      const header = headerInput ? headerInput.value.trim() : row.querySelector('.mapping-select').dataset.header;
      const select = row.querySelector('.mapping-select');
      if (header && select.value) {
        mapping[header] = select.value;
      }
    });

    document.getElementById('mapping-section').style.display = 'none';
    document.getElementById('preview-section').style.display = 'block';

    document.getElementById('validation-summary').classList.add('hidden');
    document.getElementById('dry-run-btn').textContent = "Run Dry Run Simulation";
    document.getElementById('start-real-import-btn').classList.add('hidden');
    document.getElementById('override-duplicates').checked = false;

    renderPreviewTableClean();
  }

  function backToMapping() {
    document.getElementById('preview-section').style.display = 'none';
    document.getElementById('mapping-section').style.display = 'block';
  }

  function cancelPreview() {
    document.getElementById('preview-section').style.display = 'none';
    document.getElementById('mapping-section').style.display = 'none';
    document.getElementById('upload-section').style.display = 'block';
    document.getElementById('file').value = '';
    currentJobId = null;
    csvHeaders = [];
    previewRows = [];
    mapping = {};
  }

  function renderPreviewTableClean() {
    const thead = document.querySelector('#preview-table thead');
    const tbody = document.querySelector('#preview-table tbody');

    thead.innerHTML = `
      <tr>
        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">#</th>
        <th class="px-6 py-3 text-left text-xs font-medium text-red-700 uppercase tracking-wider">Issues</th>
        ${csvHeaders.map(h => `<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">${h}</th>`).join('')}
      </tr>`;

    tbody.innerHTML = previewRows.map((row, idx) => `
    <tr class="hover:bg-gray-50 transition-colors">
      <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700 font-medium">
        ${idx + 1}
      </td>
      <td class="px-6 py-4 text-sm text-gray-400 italic">
        None
      </td>
      ${csvHeaders.map(header => {
        const mappedPath = mapping[header] || '';
        return `<td class="px-6 py-4 text-sm">
          <input type="text" 
                 value="${(row[header] || '').replace(/"/g, '&quot;')}" 
                 class="w-full px-3 py-2 border border-gray-300 rounded bg-white focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-shadow"
                 oninput="handleCellEdit(this, ${idx}, '${header}')">
          ${mappedPath ? `<div class="text-xs text-green-600 mt-1 font-medium">‚Üí ${mappedPath}</div>` : ''}
        </td>`;
      }).join('')}
    </tr>
  `).join('');
  }


function updateDryRunButton() {
  const btn = document.getElementById('dry-run-btn');
  if (hasUnvalidatedChanges) {
    btn.textContent = "Validate Changes ‚ö°";
    btn.classList.add('animate-pulse', 'ring-4', 'ring-indigo-300', 'bg-indigo-700');
  } else {
    btn.textContent = currentValidation ? "Re-run Dry Run" : "Run Dry Run Simulation";
    btn.classList.remove('animate-pulse', 'ring-4', 'ring-indigo-300', 'bg-indigo-700');
  }
}

function handleCellEdit(inputElement, rowIndex, header) {
  const newValue = inputElement.value.trim();
  const oldValue = (previewRows[rowIndex][header] || '').trim();

  if (newValue !== oldValue) {
    previewRows[rowIndex][header] = newValue;
    hasUnvalidatedChanges = true;
    updateDryRunButton();

    // Immediately disable import until re-validated
    document.getElementById('start-real-import-btn').disabled = true;
  }
}

function renderPreviewTableWithValidation(validationRows) {
  // Store validation state
  currentValidation = {};
  validationRows.forEach(r => {
    currentValidation[r.row_number] = {
      status: r.status,
      issues: r.issues || []
    };
  });

  // User made edits ‚Üí now validated ‚Üí reset flag
  hasUnvalidatedChanges = false;
  updateDryRunButton();

  const thead = document.querySelector('#preview-table thead');
  const tbody = document.querySelector('#preview-table tbody');

  // Header with dedicated "Issues" column
  thead.innerHTML = `
    <tr>
      <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">#</th>
      <th class="px-6 py-3 text-left text-xs font-medium text-red-700 uppercase tracking-wider">Issues</th>
      ${csvHeaders.map(h => `
        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">${h}</th>
      `).join('')}
    </tr>`;

  tbody.innerHTML = previewRows.map((row, idx) => {
    const rowNum = idx + 2; // actual CSV row number
    const val = currentValidation[rowNum] || { status: "valid", issues: [] };

    // Apply override for both QBO and local duplicates
    let filteredIssues = val.issues;
    if (overrideDuplicates) {
      filteredIssues = val.issues.filter(iss =>
        iss.code !== "qbo_duplicate_displayname" &&
        iss.code !== "local_duplicate_displayname"
      );
    }

    const effectiveStatus = filteredIssues.length === 0 ? "valid" : "error";
    const rowClass = effectiveStatus === "valid"
      ? "bg-green-50 hover:bg-green-100"
      : "bg-red-50 border-l-4 border-red-600 hover:bg-red-100";

    // Group issues by field ‚Äî with normalization
    const fieldIssues = {};
    filteredIssues.forEach(iss => {
      let field = iss.field || "General";

      // Normalize common Pydantic quirks
      if (field === "PrimaryEmailAddr") field = "PrimaryEmailAddr.Address";
      if (field === "PrimaryPhone") field = "PrimaryPhone.FreeFormNumber";
      if (field === "Mobile") field = "Mobile.FreeFormNumber";
      if (field === "Fax") field = "Fax.FreeFormNumber";
      if (field === "AlternatePhone") field = "AlternatePhone.FreeFormNumber";
      if (field === "WebAddr") field = "WebAddr.URI";

      fieldIssues[field] = fieldIssues[field] || [];
      fieldIssues[field].push(iss.message);
    });

    // General issues (no field assigned)
    const generalIssues = (fieldIssues["General"] || [])
      .map(msg => `<div class="text-xs text-red-700 font-medium mb-1">‚ö† ${msg}</div>`)
      .join('') || '<span class="text-gray-400 text-xs">None</span>';

    delete fieldIssues["General"]; // Remove so it doesn't leak into cells

    return `<tr class="${rowClass}">
      <td class="px-6 py-4 whitespace-nowrap text-sm font-medium ${effectiveStatus === "valid" ? 'text-green-900' : 'text-red-900'}">
        ${idx + 1}
        ${effectiveStatus === "valid"
          ? '<span class="ml-3 text-green-600 font-bold">‚úì</span>'
          : '<span class="ml-3 text-red-600 font-bold">‚úó</span>'
        }
      </td>
      <td class="px-6 py-4 text-sm align-top max-w-xs">
        ${generalIssues}
      </td>
      ${csvHeaders.map(header => {
        const mappedPath = mapping[header] || '';
        let issues = fieldIssues[mappedPath] || [];

        // Fallback: partial match (e.g. mappedPath ends with field name)
        if (issues.length === 0 && mappedPath) {
          for (const [key, msgs] of Object.entries(fieldIssues)) {
            if (mappedPath.includes(key) || key.includes(mappedPath)) {
              issues = msgs;
              break;
            }
          }
        }

        const hasError = issues.length > 0;
        const cellBg = hasError ? "bg-red-100" : "";
        const borderColor = hasError ? "border-red-500 ring-red-200" : "border-gray-300";

        return `<td class="px-6 py-4 text-sm ${cellBg}">
          <input type="text"
                 value="${(row[header] || '').replace(/"/g, '&quot;')}"
                 class="w-full px-3 py-2 border rounded ${borderColor} bg-white focus:outline-none focus:ring-2 focus:ring-indigo-500"
                 oninput="handleCellEdit(this, ${idx}, '${header}')">
          ${mappedPath ? `<div class="text-xs text-gray-600 mt-1">‚Üí ${mappedPath}</div>` : ''}
          ${hasError
            ? `<div class="text-xs text-red-700 font-medium mt-2 flex items-start">
                 <span class="mr-1">‚ö†</span>
                 <span>${issues.join('<br>')}</span>
               </div>`
            : ''
          }
        </td>`;
      }).join('')}
    </tr>`;
  }).join('');
}

async function startDryRun() {
  if (!mapping || Object.keys(mapping).length === 0) {
    alert("Please complete mapping first");
    return;
  }

  const payload = {
    mapping: mapping,
    rows: previewRows  // ‚Üê Sends all current cell values (including user edits)
  };

  try {
    const res = await fetchWithAuth(`/api/import/customer/${currentJobId}/dry-run`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });

    if (!res.ok) throw new Error(await res.text() || "Dry run failed");

    const data = await res.json();

    // ‚Üê‚Üê‚Üê MOVE THIS LINE UP HERE ‚Äî declare s first!
    const s = data.summary;

    document.getElementById('validation-summary').classList.remove('hidden');
    document.getElementById('dry-run-btn').textContent = "Re-run Dry Run";
    document.getElementById('start-real-import-btn').classList.remove('hidden');

    // Now safe to use s everywhere
    document.getElementById('total-count').textContent = s.total_rows;
    document.getElementById('success-count').textContent = s.will_succeed;
    document.getElementById('fail-count').textContent = s.will_fail;
    document.getElementById('warning-count').textContent = s.warnings;

    // Update override state
    overrideDuplicates = document.getElementById('override-duplicates').checked;

    if (s.will_fail === 0 || (overrideDuplicates && s.will_fail <= (s.warnings || 0))) {
      document.getElementById('summary-text').textContent = "üéâ Ready to import!";
      document.getElementById('validation-summary').className = "mb-8 p-6 rounded-lg border bg-green-50 border-green-300";
      document.getElementById('start-real-import-btn').textContent = "Confirm & Start Import";
      document.getElementById('start-real-import-btn').className = "px-8 py-4 bg-green-600 text-white text-lg rounded hover:bg-green-700";
    } else {
      document.getElementById('summary-text').textContent = "‚ö†Ô∏è Some rows have issues. Edit them or override duplicates.";
      document.getElementById('validation-summary').className = "mb-8 p-6 rounded-lg border bg-orange-50 border-orange-300";
      document.getElementById('start-real-import-btn').textContent = "Import Safe Rows Only";
      document.getElementById('start-real-import-btn').className = "px-8 py-4 bg-orange-600 text-white text-lg rounded hover:bg-orange-700";
    }

    // Only enable import if truly safe (or duplicates overridden meaningfully)
    const effectiveFailCount = overrideDuplicates 
      ? Math.max(0, s.will_fail - (s.warnings || 0)) 
      : s.will_fail;
    document.getElementById('start-real-import-btn').disabled = effectiveFailCount > 0;

    renderPreviewTableWithValidation(data.rows);

    // Re-run render when override checkbox changes
    document.getElementById('override-duplicates').onchange = () => {
      overrideDuplicates = document.getElementById('override-duplicates').checked;
      renderPreviewTableWithValidation(data.rows);

      // Re-calculate button state and summary text
      const newEffectiveFail = overrideDuplicates 
        ? Math.max(0, s.will_fail - (s.warnings || 0)) 
        : s.will_fail;

      if (newEffectiveFail === 0) {
        document.getElementById('summary-text').textContent = "üéâ Ready to import!";
        document.getElementById('validation-summary').className = "mb-8 p-6 rounded-lg border bg-green-50 border-green-300";
        document.getElementById('start-real-import-btn').textContent = "Confirm & Start Import";
        document.getElementById('start-real-import-btn').className = "px-8 py-4 bg-green-600 text-white text-lg rounded hover:bg-green-700";
      } else {
        document.getElementById('summary-text').textContent = "‚ö†Ô∏è Some rows have issues. Edit them or override duplicates.";
        document.getElementById('validation-summary').className = "mb-8 p-6 rounded-lg border bg-orange-50 border-orange-300";
        document.getElementById('start-real-import-btn').textContent = "Import Safe Rows Only";
        document.getElementById('start-real-import-btn').className = "px-8 py-4 bg-orange-600 text-white text-lg rounded hover:bg-orange-700";
      }
      document.getElementById('start-real-import-btn').disabled = newEffectiveFail > 0;
    };

  } catch (err) {
    alert("Dry run failed: " + err.message);
  }
}
  async function startRealImport() {
  if (!confirm("This will import data into QuickBooks. Continue?")) return;

  const payload = {
    mapping: mapping,
    rows: previewRows,  // ‚Üê Send final edited data
    override_existing: document.getElementById('override-duplicates').checked
  };

  try {
    const res = await fetchWithAuth(`/api/import/customer/${currentJobId}/start`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });

    if (!res.ok) throw new Error(await res.text());

    alert("Import started successfully! Check 'Recent Jobs' for progress.");
    cancelPreview();
    loadJobs();
  } catch (err) {
    alert("Import failed to start: " + err.message);
  }
}

  // === CLERK INIT ===
  window.addEventListener('load', async () => {
    if (typeof Clerk === 'undefined') return alert("Clerk failed to load");

    await Clerk.load();

    const mountDiv = document.getElementById('clerk-mount');
    if (Clerk.user) {
      Clerk.mountUserButton(mountDiv);
    } else {
      const btn = document.createElement('button');
      btn.textContent = 'Sign In';
      btn.className = 'px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 text-sm';
      btn.onclick = () => Clerk.openSignIn();
      mountDiv.appendChild(btn);
    }

    updateQBOStatus();
    loadJobs();
    setInterval(updateQBOStatus, 30000);
    setInterval(loadJobs, 5000);
  });
  </script>
</body>
</html>